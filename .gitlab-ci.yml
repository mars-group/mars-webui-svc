stages:
#  - base
  - build
  - deploy

variables:
  DOCKER_HOST: "dock-one.mars.haw-hamburg.de:5555"
  DOCKER_REGISTRY: "artifactory.mars.haw-hamburg.de:5002"

cache:
  paths:
    - /usr/local/share/.cache/yarn

# this is the build image that is use for creating production and in development. It rarely changes
#build_deploy_base:
#  stage: base
#  variables:
#    SERVICE_NAME: "webui-svc-base"
#  script:
#    - export DOCKER_HOST=$DOCKER_HOST
#    - docker build -t $SERVICE_NAME:latest -f Dockerfile_base .
#    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
#    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:latest
#    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
#    - docker login -u $ARTIFACTORY_USER -p $ARTIFACTORY_PW $DOCKER_REGISTRY
#    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
#    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:latest
#    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
#  only:
#    - master

build_dependencies:
  stage: build
  image: artifactory.mars.haw-hamburg.de:5002/webui-svc-base
  script:
    - npm install --warn phantomjs-prebuilt # workaround for phantomjs being stupid
    - yarn install --no-progress # npm in fast with cache :-)
    - bower install --warn
    - 'echo "{
          \"pipelineId\": \"$CI_PIPELINE_ID\",
          \"commitId\": \"$CI_COMMIT_SHA\"
      }" > src/version.json'
    - gulp  # build dist/
    - yarn install --no-progress --production # cleanup development packages
  only:
    - master
  artifacts:
    expire_in: 1 hour
    paths:
      - node_modules/
      - dist/
  cache:
    paths:
      - bower_components/

deploy_production:
  stage: deploy
  variables:
    SERVICE_NAME: "webui-svc"
  script:
    - mv node_modules/ node_modules_prod/ # fix some strange bug, where the name causes an issue.
    - export DOCKER_HOST=$DOCKER_HOST
    - docker build -t $SERVICE_NAME:latest .
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:latest
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
    - docker login -u $ARTIFACTORY_USER -p $ARTIFACTORY_PW $DOCKER_REGISTRY
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:latest
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
  only:
    - master

deploy_development:
  stage: deploy
  variables:
    SERVICE_NAME: "webui-svc_dev"
  script:
    - rm -rf dist/
    - export DOCKER_HOST=$DOCKER_HOST
    - docker build -t $SERVICE_NAME:latest -f Dockerfile_dev .
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:latest
    - docker tag $SERVICE_NAME:latest $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
    - docker login -u $ARTIFACTORY_USER -p $ARTIFACTORY_PW $DOCKER_REGISTRY
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_PIPELINE_ID
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:latest
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_SHA
  only:
    - master
  dependencies: []
