<div id="mapping-container" class="container">

  <div>
    <acme-navbar></acme-navbar>
  </div>

  <div class="col-md-3">
    <h3>Model Aspects</h3>
    <treecontrol class="tree-boot" tree-model="mapping.treeData"
                 expanded-nodes="mapping.treeExpandedNodes" options="mapping.treeOptions"
                 on-selection="mapping.selectFirstField(node)"
                 selected-node="mapping.selectedNode">
      {{ node.LayerName }} {{ node.Name }}
    </treecontrol>
  </div>

  <div class="col-md-5">
    <!-- Error messages -->
    <uib-alert ng-repeat="alert in mapping.alerts.get()" type="{{alert.type}}" close="mapping.alerts.remove($index)">
      {{alert.msg}}
    </uib-alert>

    <form name="mappingForm" class="simple-form" novalidate ng-show="mapping.selectedNode">
      <h3>{{ mapping.selectedNode.Name }}</h3>

      <table class="table table-striped">
        <thead>
        <tr>
          <th>Fields</th>
          <th>Select Dataset</th>
          <th>Set value manually</th>
        </tr>
        </thead>
        <tbody>
        <!-- render basic layer agent fields -->
        <tr class="form-group" data-ng-repeat="field in mapping.selectedNode.ConstructorParameterMapping">
          <td class="col-md-4">
            <span>{{ field.Name }}:</span>
          </td>
          <td class="col-md-4">
            <div class="input-group" ng-hide="field.MappingType === 'ValueParameterMapping'">
              <button class="btn btn-info" ng-click="mapping.selectedField=field">
                {{ field.ColumnName ? field.ColumnName : 'select'}}
              </button>
              <button class="btn btn-link" ng-click="mapping.resetField(field)"
                      ng-show="field.ColumnName">X
              </button>
            </div>
            <div class="input-group" ng-show="field.MappingType === 'ValueParameterMapping'">
              <label><input type="text" class="form-control" ng-model="field.Value"/></label>
            </div>
          </td>
          <td class="col-md-4">
            <div class="input-group">
              <div class="checkbox">
                <label><input type="checkbox" ng-model="field.MappingType" ng-click="mapping.resetField(field)"
                              data-ng-true-value="'ValueParameterMapping'"
                              data-ng-false-value="'ColumnParameterMapping'">
                </label>
              </div>
            </div>
          </td>
        </tr>
        <!-- render other layer fields -->
        <tr class="form-group" ng-hide="mapping.selectedNode.hasOwnProperty('ConstructorParameterMapping')
        ||mapping.selectedNode.hasOwnProperty('Parameters')
        ||mapping.selectedNode.hasOwnProperty('ValidationResult')">
          <td class="col-md-4">
            dgsg: {{ mapping.selectedNode.Parameters }}
            <span>{{ mapping.selectedNode.LayerName }}{{ mapping.selectedNode.Name }}:</span>
          </td>
          <td class="col-md-4">
            <div class="input-group">
              <button class="btn btn-info" ng-click="mapping.selectedField=mapping.selectedNode">
                {{ mapping.selectedNode.ColumnName ? mapping.selectedNode.ColumnName : 'select' }}
              </button>
              <button class="btn btn-link" ng-click="mapping.resetField(mapping.selectedNode)"
                      ng-show="mapping.selectedNode.ColumnName">X
              </button>
            </div>
          </td>
          <td class="col-md-4">
            <div class="input-group">
              <div class="checkbox">
                <label><input type="checkbox" class="disabled" ng-disabled="true"></label>
              </div>
            </div>
          </td>
        </tr>

        <!-- TODO: render parameters -->

        <tr class="text-right">
          <td>
          </td>
          <td>
          </td>
          <td>
            <button class="btn btn-warning" type="button" ng-click="mapping.cancel()">Cancel</button>
            <button class="btn btn-primary" type="submit" ng-click="mapping.save()"
                    data-ng-disabled="mappingForm.$invalid">Save
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </form>
  </div>

  <div class="col-md-4" ng-show="mapping.selectedNode">
    <h3>Select Data</h3>

    <div class="form-group">
      <label for="filter" class="filter">Filter:</label>
      <input class="form-control" id="filter" type="text">
    </div>

    <uib-accordion close-others="true">
      <uib-accordion-group class="panel-default" ng-repeat="dataset in mapping.metadata">
        <uib-accordion-heading>
          {{ dataset.title }}
        </uib-accordion-heading>
        <div>Type: {{ dataset.type }}</div>
        <div>Description: {{ dataset.description }}</div>
        <div ng-show="dataset.additionalTypeSpecificData.databaseName">
          <div>ColumnNames:</div>
          <ul>
            <li ng-repeat="field in dataset.additionalTypeSpecificData.columnNames">{{ field.clearColumnName }}
              <button class="btn btn-success btn-xs" ng-click="mapping.createMapping(dataset, $index)">add</button>
            </li>
          </ul>
        </div>
      </uib-accordion-group>
    </uib-accordion>

    <!-- for debugging only -->
    <div ng-show="mapping.DEV_MODE">selected Node: {{ mapping.selectedNode |json }}</div>
    <!--<div ng-show="mapping.DEV_MODE">selected field: {{ mapping.selectedField |json }}</div>-->

  </div>

</div>
